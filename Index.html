<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Career Risk Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <style>
    /* --- your styles unchanged --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color: #333; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; color: white; margin-bottom: 30px; }
    .header h1 { font-size: 2.8rem; margin-bottom: 10px; text-shadow: 0 3px 6px rgba(0,0,0,0.3); font-weight: 700; }
    .header p { font-size: 1.2rem; opacity: 0.9; }
    .card { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 35px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      margin-bottom: 25px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .auth-badge { display: inline-block; background: linear-gradient(135deg, #4285f4, #34a853);
      color: white; padding: 8px 16px; border-radius: 25px; font-size: 14px; font-weight: 600; margin-bottom: 20px; }
    .login-section { text-align: center; }
    .google-btn { background: #4285f4; color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 16px; cursor: pointer;
      transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 12px; margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); }
    .google-btn:hover { background: #3367d6; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4); }
    .google-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .user-section { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding: 20px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; border: 2px solid #dee2e6; }
    .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
    .avatar-fallback { width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;
      font-size: 24px; font-weight: bold; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .user-info h3 { font-size: 1.3rem; color: #2c3e50; margin-bottom: 5px; }
    .user-actions { margin-left: auto; }
    .btn-small { padding: 8px 16px; font-size: 14px; border-radius: 20px; border: none; cursor: pointer;
      transition: all 0.3s ease; margin-left: 8px; }
    .btn-outline { background: transparent; border: 2px solid #667eea; color: #667eea; }
    .btn-outline:hover { background: #667eea; color: white; transform: translateY(-1px); }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; transform: translateY(-1px); }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Debug Info -->
  <div id="debugInfo" class="debug-info hidden">
    <div id="debugLog"></div>
  </div>

  <div class="container">
    <div class="header">
      <h1>üéØ Career Risk Calculator</h1>
      <p>Assess your career stability and get personalized recommendations</p>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="card">
      <div class="auth-badge">üîê Secure Google Authentication</div>
      <div class="login-section">
        <h2>Sign in to Get Started</h2>
        <p style="margin: 20px 0; color: #666;">We'll use your Google account to save your assessments securely.</p>
        <button id="loginBtn" class="google-btn">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M17.64 9.20454C17.64 8.56636 17.5827 7.95273 17.4764 7.36364H9V10.845H13.8436C13.635 11.97 13.0009 12.9231 12.0477 13.5614V15.8196H14.9564C16.6582 14.2527 17.64 11.9455 17.64 9.20454Z"
              fill="white"/>
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M9 18C11.43 18 13.4673 17.1941 14.9564 15.8195L12.0477 13.5613C11.2418 14.1013 10.2109 14.4204 9 14.4204C6.65591 14.4204 4.67182 12.8372 3.96409 10.71H0.957275V13.0418C2.43818 15.9831 5.48182 18 9 18Z"
              fill="white"/>
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M3.96409 10.7098C3.78409 10.1698 3.68182 9.59307 3.68182 8.99984C3.68182 8.40661 3.78409 7.82984 3.96409 7.28984V4.95801H0.957273C0.347727 6.17301 0 7.54757 0 8.99984C0 10.4521 0.347727 11.8266 0.957273 13.0416L3.96409 10.7098Z"
              fill="white"/>
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M9 3.57955C10.3214 3.57955 11.5077 4.03364 12.4405 4.92545L15.0218 2.34409C13.4632 0.891818 11.4259 0 9 0C5.48182 0 2.43818 2.01682 0.957275 4.95818L3.96409 7.29C4.67182 5.16273 6.65591 3.57955 9 3.57955Z"
              fill="white"/>
          </svg>
          <span id="loginBtnText">Continue with Google</span>
        </button>
      </div>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="hidden">
      <!-- User Profile -->
      <div class="card">
        <div class="auth-badge">‚úÖ Authenticated with Google</div>
        <div class="user-section" id="userSection">
          <div id="userAvatar"></div>
          <div class="user-info">
            <h3 id="userName">Loading...</h3>
            <p id="userEmail">Loading...</p>
          </div>
          <div class="user-actions">
            <button id="logoutBtn" class="btn-small btn-danger">Logout</button>
          </div>
        </div>
      </div>
      <!-- (your assessment form + results remain here unchanged) -->
    </div>
  </div>

  <script>
  const supabaseUrl = "https://wlojyyalstzebzkyjwom.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indsb2p5eWFsc3R6ZWJ6a3lqd29tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxMzY5OTgsImV4cCI6MjA3MjcxMjk5OH0.ptCGGTfLYPjwsen-h5P9OcrqKveYF1JUF9UI6RePym4";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginSection = document.getElementById("loginSection");
  const appSection = document.getElementById("appSection");

  // Handle login
  loginBtn.addEventListener("click", async () => {
    const { error } = await supabaseClient.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: "https://zippy-speculoos-0fd299.netlify.app",
      },
    });
    if (error) {
      console.error("Login error:", error);
      alert("Login failed: " + error.message);
    }
  });

  // Handle logout
  logoutBtn.addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
  });

  // --- Handle session on page load ---
  async function handleRedirect() {
    // This will parse the #access_token and store it in localStorage
    const { data, error } = await supabaseClient.auth.getSessionFromUrl({
      storeSession: true,
    });

    if (error) {
      console.error("Error handling redirect:", error);
      return;
    }

    if (data?.session) {
      showUser(data.session.user);
      // Clean the URL (remove #access_token fragment)
      window.history.replaceState({}, document.title, "/");
    }
  }

  // Listen for auth state changes
  supabaseClient.auth.onAuthStateChange((_event, session) => {
    if (session) {
      showUser(session.user);
    } else {
      loginSection.classList.remove("hidden");
      appSection.classList.add("hidden");
    }
  });

  async function checkSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
      showUser(session.user);
    }
  }

  function showUser(user) {
    document.getElementById("userName").innerText = user.user_metadata.full_name || "No name";
    document.getElementById("userEmail").innerText = user.email;
    if (user.user_metadata.avatar_url) {
      document.getElementById("userAvatar").innerHTML =
        `<img src="${user.user_metadata.avatar_url}" class="avatar" />`;
    } else {
      document.getElementById("userAvatar").innerHTML =
        `<div class="avatar-fallback">${user.email[0].toUpperCase()}</div>`;
    }
    loginSection.classList.add("hidden");
    appSection.classList.remove("hidden");
  }

  // --- Run on load ---
  if (window.location.hash.includes("access_token")) {
    handleRedirect();
  } else {
    checkSession();
  }
</script>

</body>
</html>
